{% extends "base.html" %}
{% load shop_tags %}
{% block content %}
<h1 class="text-3xl font-bold mb-1 dark:text-white transition-colors duration-300">Sports Merchandise</h1>
<p class="text-gray-600 dark:text-slate-400 mb-6 transition-colors duration-300">Shop official team gear and premium sports equipment</p>

<!-- Toolbar  Sort -->
<form method="get" class="flex items-center gap-3 mb-4">
  <select name="sort" class="border rounded px-3 py-2 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200 transition-colors duration-300">
    <option value="featured"   {% if sort == 'featured' %}selected{% endif %}>Featured</option>
    <option value="price_asc"  {% if sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
    <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
  </select>
  <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 transition-colors duration-300">Apply</button>
</form>

<!-- Add Product DI ATAS GRID using modal -->
{% if user.is_authenticated %}
  <div class="mb-4 flex justify-end">
    <button id="openCreateModal"
       class="inline-flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded hover:bg-black dark:bg-slate-200 dark:text-slate-900 dark:hover:bg-white transition-colors duration-300">
      + Add Product
    </button>
  </div>
{% endif %}

<!-- Category chips -->
<div class="flex flex-wrap gap-2 mb-6">
  <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if sort %}sort={{ sort }}&{% endif %}"
     class="px-3 py-1 rounded-full border dark:border-slate-700 dark:text-slate-200 {% if not active_cat %}bg-gray-200 dark:bg-slate-700{% endif %}">All</a>
  {% for c in categories %}
    <a href="?category={{ c.slug }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if sort %}&sort={{ sort }}{% endif %}"
       class="px-3 py-1 rounded-full border dark:border-slate-700 dark:text-slate-200 {% if active_cat == c.slug %}bg-gray-800 text-white dark:bg-slate-200 dark:text-slate-900{% endif %}">{{ c.name }}</a>
  {% endfor %}
</div>

<p class="text-sm text-gray-500 dark:text-slate-400 mb-3 transition-colors duration-300">Showing {{ products|length }} of {{ page_obj.paginator.count }} products</p>

<!-- State kosong-->
{% if page_obj.paginator.count == 0 %}
  <div class="bg-white dark:bg-slate-800 rounded-xl p-10 text-center border border-transparent dark:border-slate-700 transition-colors duration-300">
    <p class="text-gray-600 dark:text-slate-300 mb-4 transition-colors duration-300">Belum ada produk untuk kategori/pencarian ini.</p>
    {% if user.is_authenticated %}
      <button id="openCreateModalEmpty" class="px-4 py-2 bg-gray-900 text-white rounded">
        Add your first product
      </button>
    {% endif %}
  </div>
{% endif %}

<!-- Grid -->
<div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
  {% for p in products %}
    <div class="relative bg-white dark:bg-slate-800 rounded-2xl shadow p-4 border border-transparent dark:border-slate-700 transition-colors duration-300" data-product-id="{{p.id}}">
      {% if p.sale_price %}<span class="absolute top-2 left-2 px-2 py-1 bg-red-500 text-white text-xs rounded">Sale</span>{% endif %}
      {% if not p.in_stock %}<span class="absolute top-2 right-2 px-2 py-1 bg-orange-500 text-white text-xs rounded">Out of Stock</span>{% endif %}
      <a href="{% url 'shop:detail' p.slug %}">
        <div class="aspect-[16/10] bg-gray-100 dark:bg-slate-700 rounded mb-4 overflow-hidden transition-colors duration-300">
          {% if p.thumbnail %}<img src="{{p.thumbnail}}" class="w-full h-full object-cover">{% endif %}
        </div>
        <div class="text-xs text-gray-500 dark:text-slate-400 mb-1 transition-colors duration-300">{{ p.category.name }}</div>
        <h3 class="font-semibold mb-1 line-clamp-2 dark:text-white transition-colors duration-300">{{ p.name }}</h3>
        <div class="text-xs text-gray-500 dark:text-slate-400 transition-colors duration-300">{% star_rating p.rating_avg 5 %} ({{ p.rating_count }})</div>
      </a>

      <!-- owner pemilik card -->
      <div class="text-xs text-gray-500 dark:text-slate-400 mt-1 transition-colors duration-300">
        {% if p.created_by_id %}by <span class="font-medium">{{ p.created_by.username }}</span>{% endif %}
      </div>

      <div class="flex items-end gap-2 mt-1">
        <div class="text-xl font-bold dark:text-white transition-colors duration-300">{{ p.final_price|price_idr }}</div>
        {% if p.sale_price %}<div class="text-gray-400 dark:text-slate-500 line-through transition-colors duration-300">{{ p.price|price_idr }}</div>{% endif %}
      </div>

      {% if show_member_price %}
        <div class="text-xs text-green-700 dark:text-green-400 mt-1 transition-colors duration-300">Member</div>
      {% endif %}

      <div class="mt-3">
        {# Owner tidak boleh add to cart #}
        <button
          class="add-to-cart px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 transition
                 {% if not p.in_stock %}
                    opacity-50 cursor-not-allowed
                 {% elif user.is_authenticated and p.created_by_id == user.id %}
                    opacity-50 cursor-not-allowed
                 {% endif %}"
          {% if not p.in_stock %}
            disabled
          {% elif user.is_authenticated and p.created_by_id == user.id %}
            disabled
          {% endif %}
        >
          {% if user.is_authenticated and p.created_by_id == user.id %}
            Your product
          {% else %}
            Add to Cart
          {% endif %}
        </button>
        {% if user.is_authenticated and user.is_staff or user.is_authenticated and p.created_by_id == user.id %}
          <div class="mt-2 flex gap-2">
            <a href="{% url 'shop:edit' p.id %}" class="px-3 py-1 border rounded text-sm dark:border-slate-700 dark:text-slate-200 transition-colors duration-300">Edit</a>
            <button class="px-3 py-1 border rounded text-sm text-red-600 dark:border-slate-700 dark:text-red-400 transition-colors duration-300"
                    data-action="delete" data-id="{{ p.id }}">Delete</button>
          </div>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>

<!-- Load More -->
{% if page_obj.has_next %}
  <div class="text-center mt-8">
    <button id="loadMore" data-next="{{ page_obj.next_page_number }}" class="px-5 py-2 border rounded dark:border-slate-600 dark:text-slate-200 dark:hover:bg-slate-800 transition-colors duration-300">Load More Products</button>
  </div>
{% endif %}

<!-- Modal Create Product -->
<div id="createModal" class="fixed inset-0 z-50 hidden">
  <!-- backdrop -->
  <div class="absolute inset-0 bg-black/40"></div>
  <!-- dialog -->
  <div class="absolute inset-0 flex items-start justify-center mt-16 px-4">
    <div class="w-full max-w-2xl bg-white dark:bg-slate-800 rounded-2xl shadow p-6 transition-colors duration-300">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold dark:text-white transition-colors duration-300">Create Product</h3>
        <button id="closeCreateModalX" class="text-gray-500 hover:text-black dark:text-slate-400 dark:hover:text-slate-200 transition-colors duration-300">&times;</button>
      </div>
      <div id="createModalBody">
        <!-- form fragment akan dimuat via AJAX GET /shop/create/ -->
        <div class="text-sm text-gray-500 dark:text-slate-400 transition-colors duration-300">Loading form...</div>
      </div>
    </div>
  </div>
</div>

<script>
  window.showToast = window.showToast || function (msg) { console.log('toast:', msg); };

  // ============ HELPER FUNCTIONS ============
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }
  const csrfToken = getCookie('csrftoken');
  const productsApiUrl = "{% url 'api_shop:products' %}";

  // ============ ADD TO CART FUNCTION (SINGLE VERSION) ============
  async function addToCart(productId, qty=1){
    try {
      const res = await fetch("{% url 'api_cart:add_to_cart' %}", {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "X-CSRFToken": csrfToken,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({product_id: productId, qty: qty})
      });

      const data = await res.json();

      if (!res.ok || !data.ok) {
        throw new Error(data.error || "Failed to add to cart");
      }

      // Update cart badge
      const badge = document.getElementById('cartBadge');
      if (badge) {
        badge.textContent = data.cart_count;
        badge.classList.remove('hidden');
      }

      showToast("Added to cart ✅", "success");
      return true;
    } catch (error) {
      showToast(error.message || "Failed to add to cart", "error");
      return false;
    }
  }

  // ============ ADD TO CART BUTTON HANDLER ============
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.add-to-cart');
    if (!btn || btn.disabled) return;

    const card = btn.closest('[data-product-id]');
    if (!card) return;

    const productId = card.dataset.productId;
    if (!productId) return;

    // Disable button while processing
    btn.disabled = true;
    const originalText = btn.textContent;
    btn.textContent = 'Adding...';

    await addToCart(productId, 1);

    // Re-enable button
    btn.disabled = false;
    btn.textContent = originalText;
  });

  // ============ LOAD MORE AJAX ============
  const loadBtn = document.getElementById('loadMore');
  if (loadBtn) {
    loadBtn.addEventListener('click', async () => {
      const params = new URLSearchParams(window.location.search);
      params.set('page', loadBtn.dataset.next);
      const res = await fetch(`${productsApiUrl}?${params.toString()}`);
      const data = await res.json();
      const grid = document.getElementById('grid');

      data.results.forEach(p => {
        const ownerText = p.owner ? `by <span class="font-medium">${p.owner}</span>` : '';
        const isOwner = !!p.is_owner;
        const disable = (!p.in_stock || isOwner) ? 'disabled' : '';
        const btnCls  = (!p.in_stock || isOwner) ? 'opacity-50 cursor-not-allowed' : '';
        const btnText = isOwner ? 'Your product' : 'Add to Cart';

        const el = document.createElement('div');
        el.className = "relative bg-white dark:bg-slate-800 rounded-2xl shadow p-4 border border-transparent dark:border-slate-700 transition-colors duration-300";
        el.setAttribute('data-product-id', p.id);

        el.innerHTML = `
          ${p.sale_price ? '<span class="absolute top-2 left-2 px-2 py-1 bg-red-500 text-white text-xs rounded">Sale</span>' : ''}
          ${!p.in_stock ? '<span class="absolute top-2 right-2 px-2 py-1 bg-orange-500 text-white text-xs rounded">Out of Stock</span>' : ''}
          <a href="/shop/p/${p.slug}/">
            <div class="aspect-[16/10] bg-gray-100 dark:bg-slate-700 rounded mb-4 overflow-hidden transition-colors duration-300">
              ${p.thumbnail ? `<img src="${p.thumbnail}" class="w-full h-full object-cover">` : ''}
            </div>
            <div class="text-xs text-gray-500 dark:text-slate-400 mb-1 transition-colors duration-300">${p.category ?? ''}</div>
            <h3 class="font-semibold mb-1 line-clamp-2 dark:text-white transition-colors duration-300">${p.name}</h3>
          </a>
          <div class="text-xs text-gray-500 dark:text-slate-400 mt-1 transition-colors duration-300">${ownerText}</div>
          <div class="flex items-end gap-2 mt-1">
            <div class="text-xl font-bold">Rp ${(p.sale_price ?? p.price).toLocaleString('id-ID')}</div>
            ${p.sale_price ? `<div class="text-gray-400 dark:text-slate-500 line-through transition-colors duration-300">Rp ${p.price.toLocaleString('id-ID')}</div>` : ''}
          </div>
          <div class="mt-3">
            <button class="add-to-cart px-4 py-2 bg-blue-600 text-white rounded w-full hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 transition ${btnCls}" ${disable}>${btnText}</button>
            ${isOwner ? `
              <div class="mt-2 flex gap-2">
                <a href="/shop/${p.id}/edit/" class="px-3 py-1 border rounded text-sm dark:border-slate-700 dark:text-slate-200 transition-colors duration-300">Edit</a>
                <button class="px-3 py-1 border rounded text-sm text-red-600 dark:border-slate-700 dark:text-red-400 transition-colors duration-300" data-action="delete" data-id="${p.id}">Delete</button>
              </div>` : ''}
          </div>`;
        grid.appendChild(el);
      });

      if (data.has_next) loadBtn.dataset.next = String(parseInt(loadBtn.dataset.next) + 1);
      else loadBtn.remove();
    });
  }

  // ============ MODAL CREATE PRODUCT ============
  const modal = document.getElementById('createModal');
  const modalBody = document.getElementById('createModalBody');
  const openButtons = [
    document.getElementById('openCreateModal'),
    document.getElementById('openCreateModalEmpty')
  ].filter(Boolean);
  const closeX = document.getElementById('closeCreateModalX');

  function openCreateModal() {
    modal.classList.remove('hidden');
    fetch("{% url 'shop:create' %}", { headers: {"X-Requested-With": "XMLHttpRequest"} })
      .then(r => r.json())
      .then(({html}) => {
        modalBody.innerHTML = html;
        bindCreateFormHandlers();
      });
  }

  function closeCreateModal() {
    modal.classList.add('hidden');
    modalBody.innerHTML = '';
  }

  openButtons.forEach(btn => btn?.addEventListener('click', (e) => { e.preventDefault(); openCreateModal(); }));
  closeX?.addEventListener('click', closeCreateModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeCreateModal();
  });

  function bindCreateFormHandlers() {
    const cancel = document.getElementById('closeCreateModal');
    cancel?.addEventListener('click', closeCreateModal);

    const form = document.getElementById('productCreateForm');
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const res = await fetch("{% url 'shop:create' %}", {
        method: "POST",
        headers: {"X-Requested-With": "XMLHttpRequest"},
        body: fd
      });
      const data = await res.json();

      if (!data.ok && data.html) {
        modalBody.innerHTML = data.html;
        bindCreateFormHandlers();
        return;
      }

      closeCreateModal();
      const p = data.product;
      const ownerText = p.owner ? `by <span class="font-medium">${p.owner}</span>` : 'by <span class="font-medium">you</span>';
      const grid = document.getElementById('grid');
      const el = document.createElement('div');
      el.className = "relative bg-white dark:bg-slate-800 rounded-2xl shadow p-4 border border-transparent dark:border-slate-700 transition-colors duration-300";
      el.setAttribute('data-product-id', p.id);
      el.innerHTML = `
        ${p.sale_price ? '<span class="absolute top-2 left-2 px-2 py-1 bg-red-500 text-white text-xs rounded">Sale</span>' : ''}
        ${!p.in_stock ? '<span class="absolute top-2 right-2 px-2 py-1 bg-orange-500 text-white text-xs rounded">Out of Stock</span>' : ''}
        <a href="/shop/p/${p.slug}/">
          <div class="aspect-[16/10] bg-gray-100 dark:bg-slate-700 rounded mb-4 overflow-hidden transition-colors duration-300">
            ${p.thumbnail ? `<img src="${p.thumbnail}" class="w-full h-full object-cover">` : ''}
          </div>
          <div class="text-xs text-gray-500 dark:text-slate-400 mb-1 transition-colors duration-300">${p.category ?? ''}</div>
          <h3 class="font-semibold mb-1 line-clamp-2 dark:text-white transition-colors duration-300">${p.name}</h3>
        </a>
        <div class="text-xs text-gray-500 dark:text-slate-400 mt-1 transition-colors duration-300">${ownerText}</div>
        <div class="flex items-end gap-2 mt-1">
          <div class="text-xl font-bold">Rp ${(p.sale_price ?? p.price).toLocaleString('id-ID')}</div>
          ${p.sale_price ? `<div class="text-gray-400 dark:text-slate-500 line-through transition-colors duration-300">Rp ${p.price.toLocaleString('id-ID')}</div>` : ''}
        </div>
        <div class="mt-3">
          <button class="add-to-cart px-4 py-2 bg-blue-600 text-white rounded w-full opacity-50 cursor-not-allowed" disabled>
            Your product
          </button>
          <div class="mt-2 flex gap-2">
            <a href="/shop/${p.id}/edit/" class="px-3 py-1 border rounded text-sm dark:border-slate-700 dark:text-slate-200 transition-colors duration-300">Edit</a>
            <button class="px-3 py-1 border rounded text-sm text-red-600 dark:border-slate-700 dark:text-red-400 transition-colors duration-300" data-action="delete" data-id="${p.id}">Delete</button>
          </div>
        </div>`;

      grid.prepend(el);
      showToast('Product created ✅', 'success');
    });
  }

  // ============ DELETE PRODUCT ============
  document.addEventListener('click', async (e) => {
    const delBtn = e.target.closest('[data-action="delete"]');
    if (!delBtn) return;

    const id = delBtn.getAttribute('data-id');
    if (!id || !confirm('Delete this product?')) return;

    const res = await fetch(`/shop/${id}/delete/`, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrfToken
      }
    });

    if (!res.ok) {
      showToast('Failed to delete product', 'error');
      return;
    }

    const card = delBtn.closest('[data-product-id]');
    if (card) card.remove();
    showToast('Product deleted ✅', 'success');
  });
</script>

{% include 'toast.html' %}
{% endblock %}
