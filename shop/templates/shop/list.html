{% extends "base.html" %}
{% block content %}
<h1 class="text-3xl font-bold mb-1">Sports Merchandise</h1>
<p class="text-gray-600 mb-6">Shop official team gear and premium sports equipment</p>

<!-- Search (nanti bisa dihubungkan modul Search) -->
<form method="get" class="flex items-center gap-3 mb-4">
  <input name="q" value="{{ request.GET.q }}" placeholder="Search products..." class="flex-1 border rounded px-3 py-2">
  <select name="sort" class="border rounded px-3 py-2">
    <option value="featured" {% if sort == 'featured' %}selected{% endif %}>Featured</option>
    <option value="price_asc" {% if sort == 'price_asc' %}selected{% endif %}>Price: Low to High</option>
    <option value="price_desc" {% if sort == 'price_desc' %}selected{% endif %}>Price: High to Low</option>
  </select>
  <button class="px-4 py-2 bg-blue-600 text-white rounded">Apply</button>
</form>

<!-- Category chips -->
<div class="flex flex-wrap gap-2 mb-6">
  <a href="?{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if sort %}sort={{ sort }}&{% endif %}"
   class="px-3 py-1 rounded-full border {% if not active_cat %}bg-gray-200{% endif %}">
  All
</a>

  {% for c in categories %}
    <a href="?category={{c.slug}}{% if request.GET.q %}&q={{request.GET.q}}{% endif %}{% if sort %}&sort={{sort}}{% endif %}"
       class="px-3 py-1 rounded-full border {% if active_cat == c.slug %}bg-gray-800 text-white{% endif %}"
>{{ c.name }}</a>
  {% endfor %}
</div>

<p class="text-sm text-gray-500 mb-3">Showing {{ products|length }} of {{ page_obj.paginator.count }} products</p>

<!-- Grid -->
<div id="grid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
  {% for p in products %}
    <div class="bg-white rounded-2xl shadow p-4" data-product-id="{{p.id}}">
      {% if p.sale_price %}<span class="absolute m-2 px-2 py-1 bg-red-500 text-white text-xs rounded">Sale</span>{% endif %}
      {% if not p.in_stock %}<span class="absolute m-2 right-2 px-2 py-1 bg-orange-500 text-white text-xs rounded">Out of Stock</span>{% endif %}
      <a href="{% url 'shop:detail' p.slug %}">
        <div class="aspect-[16/10] bg-gray-100 rounded mb-4 overflow-hidden">
          {% if p.thumbnail %}<img src="{{p.thumbnail}}" class="w-full h-full object-cover">{% endif %}
        </div>
        <div class="text-xs text-gray-500 mb-1">{{ p.category.name }}</div>
        <h3 class="font-semibold mb-1 line-clamp-2">{{ p.name }}</h3>
      </a>

      <div class="flex items-end gap-2">
        <div class="text-xl font-bold">Rp {{ p.final_price|floatformat:0 }}</div>
        {% if p.sale_price %}
          <div class="text-gray-400 line-through">Rp {{ p.price|floatformat:0 }}</div>
        {% endif %}
      </div>

      {% if show_member_price %}
        <!-- contoh filter info khusus login -->
        <div class="text-xs text-green-700 mt-1">Member price visible</div>
      {% endif %}

      <div class="mt-3">
        <button
  class="add-to-cart px-4 py-2 bg-blue-600 text-white rounded w-full {% if not p.in_stock %}opacity-50 cursor-not-allowed{% endif %}"
  {% if not p.in_stock %}disabled{% endif %}>

          Add to Cart
        </button>
      </div>
    </div>
  {% endfor %}
</div>

{% if page_obj.has_next %}
  <div class="text-center mt-8">
    <button id="loadMore" data-next="{{ page_obj.next_page_number }}" class="px-5 py-2 border rounded">Load More Products</button>
  </div>
{% endif %}

<script>
  // AJAX Load More (untuk rubrik JavaScript + AJAX GET)
  const loadBtn = document.getElementById('loadMore');
  if (loadBtn) {
    loadBtn.addEventListener('click', async () => {
      const params = new URLSearchParams(window.location.search);
      params.set('page', loadBtn.dataset.next);
      const res = await fetch(`/shop/api/products/?${params.toString()}`);
      const data = await res.json();
      const grid = document.getElementById('grid');

      data.results.forEach(p => {
        const el = document.createElement('div');
        el.className = "bg-white rounded-2xl shadow p-4";
        el.innerHTML = `
          ${p.sale_price ? '<span class="absolute m-2 px-2 py-1 bg-red-500 text-white text-xs rounded">Sale</span>' : ''}
          ${!p.in_stock ? '<span class="absolute m-2 right-2 px-2 py-1 bg-orange-500 text-white text-xs rounded">Out of Stock</span>' : ''}
          <a href="/shop/p/${p.slug}/">
            <div class="aspect-[16/10] bg-gray-100 rounded mb-4 overflow-hidden">
              ${p.thumbnail ? `<img src="${p.thumbnail}" class="w-full h-full object-cover">` : ''}
            </div>
            <div class="text-xs text-gray-500 mb-1">${p.category ?? ''}</div>
            <h3 class="font-semibold mb-1 line-clamp-2">${p.name}</h3>
          </a>
          <div class="flex items-end gap-2">
            <div class="text-xl font-bold">Rp ${(p.sale_price ?? p.price).toLocaleString('id-ID')}</div>
            ${p.sale_price ? `<div class="text-gray-400 line-through">Rp ${p.price.toLocaleString('id-ID')}</div>` : ''}
          </div>
          <div class="mt-3">
            <button class="add-to-cart px-4 py-2 bg-blue-600 text-white rounded w-full" ${!p.in_stock ? 'disabled' : ''}>Add to Cart</button>
          </div>`;
        grid.appendChild(el);
      });

      if (data.has_next) {
        loadBtn.dataset.next = String(parseInt(loadBtn.dataset.next) + 1);
      } else {
        loadBtn.remove();
      }
    });
  }

  // Trigger event untuk modul “Fitur Belanja” (decoupled)
  document.addEventListener('click', (e) => {
    if (e.target.closest('.add-to-cart')) {
      const card = e.target.closest('[data-product-id]');
      if (!card) return;
      const id = card.dataset.productId;
      const name = card.querySelector('h3')?.textContent ?? '';
      const price = card.querySelector('.font-bold')?.textContent ?? '';
      const ev = new CustomEvent('product:added', { detail: { id, name, price }});
      document.dispatchEvent(ev);
    }
  });
</script>
{% endblock %}
